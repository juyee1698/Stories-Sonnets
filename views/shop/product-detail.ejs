<%- include('../includes/head.ejs') %>

</head>

<body>
	<%- include('../includes/navigation.ejs') %>

	<!--================Single Product Area =================-->
	<div class="product_image_area">
		<div class="container">
			<div class="row s_product_inner">
				<div class="col-lg-4">
					<!-- <div class="s_product_img">
						<div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
							<ol class="carousel-indicators">
								<li data-target="#carouselExampleIndicators" data-slide-to="0" class="active">
									<img src="<%= prod.imageUrl %>" alt="<%= prod.title %>">
								</li>
							</ol>
							<div class="carousel-inner">
								<div class="carousel-item active">
									<img class="d-block w-100" src="/<%= prod.imageUrl %>" alt="<%= prod.title %>">
								</div>
							</div>
						</div>
					</div> -->
					<div class="card_image">
						<img src="/<%= prod.imageUrl %>" alt="<%= prod.title %>">
					</div>
				</div>
				<div class="col-lg-7 offset-lg-1">
					<div class="s_product_text">
						<h3><%= prod.title %></h3>
						<h2>â‚¹<%= prod.price %></h2>
						<ul class="list">
							<li>
								<a class="active" href="/authors/<%= author._id %>">
									<span>Author</span><%= author.name %></a>
							</li>
							<li>
								<% if (prod.tags.length > 0) { %>
								<a href="#"><span>Tags</span></a>

								<% for (let tag of prod.tags) { %>
								<a href="/products/tags/<%= tag %>"><%= tag %></a><span>,</span>
								<% } %>



								<% } %>
							</li>
							<!-- <li>

								<a class="active" href="#">
									<span>Tags</span><%= prod.tags %></a>
							</li> -->
							<li>
								<a href="#">
									<span>Availibility</span>In Stock</a>
							</li>
						</ul>
						<p><%= prod.description %></p>
						<div class="product_count">
							<label for="qty">Quantity:</label>
							<input type="text" name="qty" id="sst" maxlength="12" value="1" title="Quantity:"
								class="input-text qty">
							<!-- <button onclick="var result = document.getElementById('sst'); var sst = result.value; if( !isNaN( sst )) result.value++;return false;" class="increase items-count" type="button">
				                <i class="lnr lnr-chevron-up"></i>
							</button>
							<button onclick="var result = document.getElementById('sst'); var sst = result.value; if( !isNaN( sst ) &amp;&amp; sst > 0 ) result.value--;return false;" class="reduced items-count" type="button">
								<i class="lnr lnr-chevron-down"></i>
							</button> -->
						</div>
						<div class="card_area">
							<% if (userIsLoggedIn) { %>
							<%- include('../includes/add-to-cart.ejs') %>
							<% } %>
							<a class="icon_btn" href="#">
								<i class="lnr lnr lnr-diamond"></i>
							</a>
							<a class="icon_btn" href="#">
								<i class="lnr lnr lnr-heart"></i>
							</a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!--================End Single Product Area =================-->
	<!--================Product Description Area =================-->
	<section class="product_description_area">
		<div class="container">
			<ul class="nav nav-tabs" id="myTab" role="tablist">
				<li class="nav-item">
					<a class="nav-link" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home"
						aria-selected="true">Description</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab"
						aria-controls="profile" aria-selected="false">Specification</a>
				</li>
				<li class="nav-item">
					<a class="nav-link active" id="review-tab" data-toggle="tab" href="#review" role="tab"
						aria-controls="review" aria-selected="false">Reviews</a>
				</li>
			</ul>
			<div class="tab-content" id="myTabContent">
				<div class="tab-pane fade" id="home" role="tabpanel" aria-labelledby="home-tab" style="color: #61421f;">
					<p><%= prod.description %></p>
				</div>
				<div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
					<div class="table-responsive">
						<table class="table">
							<tbody>
								<tr>
									<td>
										<h5>Width</h5>
									</td>
									<td>
										<h5>128mm</h5>
									</td>
								</tr>
								<tr>
									<td>
										<h5>Height</h5>
									</td>
									<td>
										<h5>508mm</h5>
									</td>
								</tr>
								<tr>
									<td>
										<h5>Depth</h5>
									</td>
									<td>
										<h5>85mm</h5>
									</td>
								</tr>
								<tr>
									<td>
										<h5>Weight</h5>
									</td>
									<td>
										<h5>52gm</h5>
									</td>
								</tr>
								<tr>
									<td>
										<h5>Quality checking</h5>
									</td>
									<td>
										<h5>yes</h5>
									</td>
								</tr>
								<tr>
									<td>
										<h5>Freshness Duration</h5>
									</td>
									<td>
										<h5>03days</h5>
									</td>
								</tr>
								<tr>
									<td>
										<h5>When packeting</h5>
									</td>
									<td>
										<h5>Without touch of hand</h5>
									</td>
								</tr>
								<tr>
									<td>
										<h5>Each Box contains</h5>
									</td>
									<td>
										<h5>60pcs</h5>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
				<% let totalReviews = reviews.length %>
				<% if (userIsLoggedIn) { %>
				<div class="tab-pane fade show active" id="review" role="tabpanel" aria-labelledby="review-tab">
					<div class="row">
						<div class="col-lg-6" id="allReviews">
							<div class="row total_rate">
								<div class="col-6">
									<div class="box_total">
										<h5>Overall</h5>
										<h4><%= overall %></h4>
										<h6>(<%= reviews.length %> Reviews)</h6>
									</div>
								</div>
								<div class="col-6">
									<div class="rating_list">

										<ul class="list">
											<li>
												<a href="#">5 Star
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i> </a>
											</li>
											<li>
												<a href="#">4 Star
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i>
													<i class="fa fa-star-o"></i></a>
											</li>
											<li>
												<a href="#">3 Star
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i>
													<i class="fa fa-star-o"></i>
													<i class="fa fa-star-o"></i></a>
											</li>
											<li>
												<a href="#">2 Star
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i>
													<i class="fa fa-star-o"></i>
													<i class="fa fa-star-o"></i>
													<i class="fa fa-star-o"></i> </a>
											</li>
											<li>
												<a href="#">1 Star
													<i class="fa fa-star"></i>
													<i class="fa fa-star-o"></i>
													<i class="fa fa-star-o"></i>
													<i class="fa fa-star-o"></i>
													<i class="fa fa-star-o"></i> </a>
											</li>
										</ul>
									</div>
								</div>
							</div>
							<br>
							<% if(reviews.length>0) { %>
							<div class="review_list" id="reviewList">
								<% for(let review of reviews) { %>
								<div class="review_item" id="displayReviews">
									<div class="media">
										<!-- <div class="d-flex">
											<img src="img/product/single-product/review-1.png" alt="">
										</div> -->
										<div class="media-body">

											<a href="/profile/<%= review.userId._id %>">
												<h4><%= review.userName %></h4>
											</a>
											<% for (var i =1; i <=review.rating;  i++ ) { %>
											<i class="fa fa-star"></i>
											<% } %>
											<% for (var i =1; i <=5-review.rating;  i++ ) { %>
											<i class="fa fa-star-o"></i>
											<% } %>
										</div>
									</div>
									<h5><%= review.summary %></h5>
									<p><%= review.text %></p>
								</div>
								<% } %>

							</div>
							<% } else { %>
							<div class="review_list" id="noReviews">
								<div class="review_item">
									<h3 style="color: rgb(63, 49, 31);">No reviews yet...</h3>
								</div>
							</div>
							<% } %>
						</div>
						<div class="col-lg-6">
							<div class="review_box" id="reviewBox">
								<h4>Add a Review</h4>

								<!-- <ul class="list">
									<li>
										<a href="#">
											<i class="fa fa-star"></i>
										</a>
									</li>
									<li>
										<a href="#">
											<i class="fa fa-star"></i>
										</a>
									</li>
									<li>
										<a href="#">
											<i class="fa fa-star"></i>
										</a>
									</li>
									<li>
										<a href="#">
											<i class="fa fa-star"></i>
										</a>
									</li>
									<li>
										<a href="#">
											<i class="fa fa-star"></i>
										</a>
									</li>
								</ul> -->
								<!-- <p>Outstanding</p> -->

								<form class="row contact_form" id="reviewForm">

									<div class="col-md-12">

										<div class="rating">
											<p>Your Rating:</p>
											<span><input type="radio" name="rating" id="str5" value="5"><label
													for="str5"></label></span>
											<span><input type="radio" name="rating" id="str4" value="4"><label
													for="str4"></label></span>
											<span><input type="radio" name="rating" id="str3" value="3"><label
													for="str3"></label></span>
											<span><input type="radio" name="rating" id="str2" value="2"><label
													for="str2"></label></span>
											<span><input type="radio" name="rating" id="str1" value="1"><label
													for="str1"></label></span>
										</div>
										<br>
										<div class="form-group">
											<input type="text" class="form-control"
												value="<% if(hasError) { %><%= review.summary %><% } %>" name="summary"
												id="summary" placeholder="Summary">
										</div>
										<div class="form-group">
											<textarea class="form-control" name="text" id="text" rows="1"
												placeholder="Write a review"><% if(hasError) { %><%= review.text %><% } %></textarea>
										</div>
									</div>
									<input type="hidden" value="<%= JSON.stringify(prod) %>" name="product">
									<input type="hidden" value="<%= JSON.stringify(author) %>" name="author">
									<input type="hidden" name="_csrf" value="<%= csrfToken %>">
									<div class="col-md-12 text-right">
										<button type="submit" class="btn submit_btn">Submit Now</button>
									</div>
								</form>
								
								<br><br>
								<!-- <div class="user-message user-message--error" id="error"></div> -->
								
							</div>
						</div>
					</div>
				</div>
				<% } else {%>
				<div class="tab-pane fade show active" id="review" role="tabpanel" aria-labelledby="review-tab">
					<div class="row">
						<div class="col-lg-12">
							<div class="row total_rate">
								<div class="col-6">
									<div class="box_total">
										<h5>Overall</h5>
										<h4><%= overall %></h4>
										<h6>(<%= reviews.length %> Reviews)</h6>
									</div>
								</div>
								<div class="col-6">
									<div class="rating_list">

										<ul class="list">
											<li>
												<a href="#">5 Star
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i> </a>
											</li>
											<li>
												<a href="#">4 Star
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i>
													<i class="fa fa-star-o"></i></a>
											</li>
											<li>
												<a href="#">3 Star
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i>
													<i class="fa fa-star-o"></i>
													<i class="fa fa-star-o"></i></a>
											</li>
											<li>
												<a href="#">2 Star
													<i class="fa fa-star"></i>
													<i class="fa fa-star"></i>
													<i class="fa fa-star-o"></i>
													<i class="fa fa-star-o"></i>
													<i class="fa fa-star-o"></i> </a>
											</li>
											<li>
												<a href="#">1 Star
													<i class="fa fa-star"></i>
													<i class="fa fa-star-o"></i>
													<i class="fa fa-star-o"></i>
													<i class="fa fa-star-o"></i>
													<i class="fa fa-star-o"></i> </a>
											</li>
										</ul>
									</div>
								</div>
							</div>
							<% if(reviews.length>0) { %>
							<div class="review_list" id="reviewList">
								<% for(let review of reviews) { %>
								<div class="review_item" id="displayReviews">
									<div class="media">
										<!-- <div class="d-flex">
												<img src="img/product/single-product/review-1.png" alt="">
											</div> -->
										<div class="media-body">
											<a href="/profile/<%= review.userId._id %>">
												<h4><%= review.userName %></h4>
											</a>
											<% for (var i =1; i <=review.rating;  i++ ) { %>
											<i class="fa fa-star"></i>
											<% } %>
											<% for (var i =1; i <=5-review.rating;  i++ ) { %>
											<i class="fa fa-star-o"></i>
											<% } %>
										</div>
									</div>
									<h5><%= review.summary %></h5>
									<p><%= review.text %></p>
								</div>
								<% } %>

							</div>
							<% } else { %>
							<div class="review_list" id="noReviews">
								<div class="review_item">
									<h3 style="color: rgb(63, 49, 31);">No reviews yet...</h3>
								</div>
							</div>
							<% } %>
						</div>

					</div>
				</div>
				<% } %>
			</div>
		</div>
	</section>
	<!--================End Product Description Area =================-->

	<script src="https://code.jquery.com/jquery-1.11.2.min.js"
		integrity="sha256-Ls0pXSlb7AYs7evhd+VLnWsZ/AqEHcXBeMZUycz/CcA=" crossorigin="anonymous">
		</script>
	<script type="text/javascript">
		let userRating = 0;
		let totalReviews = '<%= reviews.length %>';
		//console.log(totalReviews);
		$(document).ready(function () {
			// Check Radio-box
			$(".rating input:radio").attr("checked", false);

			$('.rating input').click(function () {
				$(".rating span").removeClass('checked');
				$(this).parent().addClass('checked');
			});

			$('input:radio').change(
				function () {
					userRating = this.value;

				});
		},
		
		$('#reviewForm').submit(
			function (e) {
				e.preventDefault();
				if (totalReviews > 0) {
					fetch('/add-review', {
						headers: {
							'Content-Type': 'application/json',
							'csrf-token': document.querySelector('#reviewForm input[name=_csrf]').value
						},
						method: "POST",
						body: JSON.stringify({
							product: document.querySelector('#reviewForm input[name=product]').value,
							author: document.querySelector('#reviewForm input[name=author]').value,
							rating: userRating,
							text: document.querySelector('#reviewForm textarea').value,
							summary: document.querySelector('#reviewForm input[name=summary]').value
						})
					}).then((response) => {

						response.json()
							.then(data => {
								console.log(data);
								if(data.errorMessage) {
									console.log(data);
									//let reviewBox = document.getElementById("reviewBox");
									let userMessage = document.createElement("div");
									userMessage.classList.add("user-message", "user-message--error");
									userMessage.innerText = data.errorMessage;
									document.getElementById("reviewBox").append(userMessage);
									console.log("EOF");
								}
								else {
									let displayReviews = document.getElementById("displayReviews");

									// Creating a new review element
									// Creating the elements
									let newReview = document.createElement("div");
									newReview.className = "review_item";
									let media = document.createElement("div");
									media.className = "media"
									let mediaBody = document.createElement("div");
									mediaBody.className = "media-body"
									let userNameElement = document.createElement("h4");
									userNameElement.innerText = data.userName;
									let reviewSummary = document.createElement("h5");
									reviewSummary.innerText = data.summary;
									let reviewText = document.createElement("p");
									reviewText.innerText = data.text;

									// Injecting the elements
									newReview.appendChild(media);
									media.appendChild(mediaBody);
									mediaBody.appendChild(userNameElement);
									for (let i = 1; i <= Number(data.rating); i++) {
										let temp = document.createElement("i");
										temp.classList.add("fa", "fa-star");
										mediaBody.appendChild(temp);
									}
									for (var i = 1; i <= 5 - Number(data.rating); i++) {
										let temp = document.createElement("i");
										temp.classList.add("fa", "fa-star-o");
										mediaBody.appendChild(temp);
									}

									newReview.appendChild(reviewSummary);
									newReview.appendChild(reviewText);
									document.getElementById("reviewList").appendChild(newReview);
									console.log("EOF");
								}
							});
					});
				}
				else {
					fetch('/add-review', {
						headers: {
							'Content-Type': 'application/json',
							'csrf-token': document.querySelector('#reviewForm input[name=_csrf]').value
						},
						method: "POST",
						body: JSON.stringify({
							product: document.querySelector('#reviewForm input[name=product]').value,
							author: document.querySelector('#reviewForm input[name=author]').value,
							rating: userRating,
							text: document.querySelector('#reviewForm textarea').value,
							summary: document.querySelector('#reviewForm input[name=summary]').value
						})
					}).then((response) => {
						response.json()
							.then(data => {
								console.log(data);
								if(data.errorMessage) {
									console.log(data);
									//let reviewBox = document.getElementById("reviewBox");
									let userMessage = document.createElement("div");
									userMessage.classList.add("user-message", "user-message--error");
									userMessage.innerText = data.errorMessage;
									document.getElementById("reviewBox").append(userMessage);
									console.log("EOF");
								}
								else {
									let noReviews = document.getElementById("noReviews");
									let displayReviews = document.getElementById("displayReviews");

									// Creating a new review element
									// Creating the elements
									let allReviews = document.createElement("div");
									allReviews.className = "review_list";
									let newReview = document.createElement("div");
									newReview.className = "review_item";
									let media = document.createElement("div");
									media.className = "media"
									let mediaBody = document.createElement("div");
									mediaBody.className = "media-body"
									let userNameElement = document.createElement("h4");
									userNameElement.innerText = data.userName;
									let reviewSummary = document.createElement("h5");
									reviewSummary.innerText = data.summary;
									let reviewText = document.createElement("p");
									reviewText.innerText = data.text;

									// Injecting the elements
									newReview.appendChild(media);
									media.appendChild(mediaBody);
									mediaBody.appendChild(userNameElement);
									for (let i = 1; i <= Number(data.rating); i++) {
										let temp = document.createElement("i");
										temp.classList.add("fa", "fa-star");
										mediaBody.appendChild(temp);
									}
									for (var i = 1; i <= 5 - Number(data.rating); i++) {
										let temp = document.createElement("i");
										temp.classList.add("fa", "fa-star-o");
										mediaBody.appendChild(temp);
									}
									noReviews.remove();
									newReview.appendChild(reviewSummary);
									newReview.appendChild(reviewText);
									//document.getElementById("reviewList").appendChild(newReview);
									allReviews.appendChild(newReview);
									document.getElementById("allReviews").appendChild(allReviews);
									//console.log("EOF");
									}
								
							});
					});
				}


			})
	
	);


	</script>
	<!-- // <script src="/js/review.js" type = 'text/javascript'></script>  -->

	<%- include('../includes/end.ejs') %>